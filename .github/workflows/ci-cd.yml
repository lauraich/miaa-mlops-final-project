name: CI/CD Azure

on:
  push:
    branches:
      - dev
      - prod

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'dev' && 'dev' || 'prod' }}

    steps:
    - name: üèóÔ∏è Checkout repo
      uses: actions/checkout@v4
    
    # --------------------------
    - name: üõ†Ô∏è Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        if [ -f app/requirements.txt ]; then pip install -r app/requirements.txt; fi
    
    # --------------------------
    - name: üì° Run connection tests
      run: |
        if [[ "$GITHUB_REF_NAME" == "dev" ]]; then
          ENVIRONMENT="dev"
        else
          ENVIRONMENT="prod"
        fi
        pytest app/test/test_inference.py -v --maxfail=1 --disable-warnings
      env:
        ENVIRONMENT: ${{ vars.ENVIRONMENT }}
        AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
        AZURE_CONTAINER_NAME: ${{ secrets.AZURE_CONTAINER_NAME }}
        TEST_IMAGES_CONTAINER: ${{ secrets.TEST_IMAGES_CONTAINER }}
        AZURE_MODEL_BLOB: ${{ secrets.AZURE_MODEL_BLOB }}
        AZURE_LOG_CONTAINER_NAME: ${{ secrets.AZURE_LOG_CONTAINER_NAME }}

    # --------------------------
    - name: üìä Run stability tests
      run: |
        if [[ "$GITHUB_REF_NAME" == "dev" ]]; then
          ENVIRONMENT="dev"
        else
          ENVIRONMENT="prod"
        fi
        pytest app/test/test_metric_stability.py -v -s --maxfail=1 --disable-warnings
      env:
        ENVIRONMENT: ${{ vars.ENVIRONMENT }}
        AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
        AZURE_CONTAINER_NAME: ${{ secrets.AZURE_CONTAINER_NAME }}
        TEST_IMAGES_CONTAINER: ${{ secrets.TEST_IMAGES_CONTAINER }}
        AZURE_MODEL_BLOB: ${{ secrets.AZURE_MODEL_BLOB }}
        AZURE_LOG_CONTAINER_NAME: ${{ secrets.AZURE_LOG_CONTAINER_NAME }}

    # --------------------------
    - name: üîê Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # --------------------------
    - name: üì¶ Build Docker image
      run: |
        if [[ "${{ github.ref_name }}" == "dev" ]]; then
          ENVIRONMENT="dev"
        else
          ENVIRONMENT="prod"
        fi
        echo "ENVIRONMENT=$ENVIRONMENT" >> $GITHUB_ENV
        
        IMAGE_NAME="${{ secrets.REGISTRY_LOGIN_SERVER }}/object-identifier-${ENVIRONMENT}"
        
        # Build with SHA tags
        docker build -t $IMAGE_NAME:${{ github.sha }} .
      
      shell: bash
      env:
        REGISTRY_LOGIN_SERVER: ${{ secrets.REGISTRY_LOGIN_SERVER }}
    
    
    # --------------------------
    - name: üîí ACR Login
      run: |
        echo ${{ secrets.REGISTRY_PASSWORD }} | docker login ${{ secrets.REGISTRY_LOGIN_SERVER }} \
            --username ${{ secrets.REGISTRY_USERNAME }} --password-stdin

    # --------------------------
    - name: ‚è≥ Push image to ACR
      run: |
        # Push both tags
        docker push ${{ secrets.REGISTRY_LOGIN_SERVER }}/object-identifier-${{ env.ENVIRONMENT }}:${{ github.sha }}
        
    # 5. Upload artifacts to Azure Blob Storage
    # --------------------------
    # - name: Install Azure Storage CLI
    #   run: |
    #     pip install azure-cli

    # - name: Upload file to Azure Storage
    #   run: |
    #     az storage blob upload \
    #       --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }} \
    #       --account-key ${{ secrets.AZURE_STORAGE_KEY }} \
    #       --container-name modelos-ml \
    #       --file modelo.pkl \
    #       --name modelo.pkl \
    #       --overwrite true

    # --------------------------
    # 6. Deploy to Azure Web App / Container App
    # --------------------------
    - name: üöÄ Build and deploy Container App
      uses: azure/container-apps-deploy-action@v1
      with:
          acrName: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          containerAppName: ${{ secrets.AZURE_CONTAINER_APP_NAME }}
          resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP_NAME }}
          imageToDeploy: ${{ secrets.REGISTRY_LOGIN_SERVER }}/object-identifier-${{ env.ENVIRONMENT }}:${{ github.sha }}
